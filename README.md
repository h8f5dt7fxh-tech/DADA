# 운송사 관리 시스템

컨테이너 수입/수출, 벌크화물, LCL 운송 오더를 종합 관리하는 웹 애플리케이션입니다.

## 🚀 프로젝트 정보

- **프로젝트명**: 운송사 관리 시스템 (Transport Management System)
- **기술 스택**: Hono + TypeScript + Cloudflare D1 + TailwindCSS
- **개발 환경**: Cloudflare Pages + Workers
- **데이터베이스**: D1 SQLite (로컬 개발)

## 🌐 접속 URL

- **Production**: https://transport-system-f56.pages.dev
- **Latest Deploy**: https://7d9532e7.transport-system-f56.pages.dev
- **Sandbox**: https://3000-irsxsviqsdywj25uoyoar-583b4d74.sandbox.novita.ai
- **GitHub**: https://github.com/h8f5dt7fxh-tech/DADA

## 📊 현재 데이터 현황

- **총 오더 수**: 28건
  - 2026년 1월: 28건 (1월 8일: 22건)
- **청구처-영업담당자 매핑**: 144개
- **화주**: 167개 (자동 학습 포함)
- **배차업체**: 164개
- **견적 관리**: 화주별 견적 시스템
- **기본 뷰**: 일별 (2026-01-08)

## ✅ 완료된 기능

### 1. 운송 오더 관리
- ✅ 월/주/일별 조회
- ✅ 실시간 검색 (2~3글자)
- ✅ 컨테이너 수출/수입, 벌크화물, LCL 구분
- ✅ 운송일시 순 정렬
- ✅ 상태 관리 (미배정/미배차/완료)
- ✅ 계근 필수 체크

### 2. 오더 입력 (3가지 방식)
- ✅ **텍스트 자동 파싱** - 붙여넣기로 자동 분석
- ✅ **직접 입력 폼** - 오더 타입별 빈 양식 제공
  - 컨테이너 수출: BKG/SIZE, 청구처, 화주, 작업지, 담당자/연락처, 작업일시, 선사, 모선, 수출국, 접안일/출항일, 상차지/하차지, 중량, 배차, 차량, 컨테이너 넘버/T.W/씰 넘버, 비고
  - 컨테이너 수입: BL, 컨테이너 넘버/SIZE, 청구처, 화주, 작업지, 담당자/연락처, 작업일시, 선사, 모선, 접안일/출항일, 상차지/하차지, DO, 면장, 배차, 차량, 비고
  - 벌크화물/LCL: NO, 청구처, 화주, 선사, 상차지, 하차지, 배차, 차량, 차량정보, 비고
- ✅ **엑셀 업로드** - 엑셀 파일로 오더 일괄 등록
- ✅ BKG/BL/컨테이너 정보 파싱
- ✅ 비고 여러 개 추가 (중요도 설정)

### 3. 배정/배차 복사
- ✅ 배정 복사 (진행일시, 화주, BKG/BL, 상하차지/작업지)
- ✅ 배차 복사 (화주/작업지, BL/BKG, 진행일시, CON, 배차정보, 비고)
- ✅ 클립보드 복사 기능

### 4. 청구/하불 관리
- ✅ 오더당 여러 청구 건 추가
- ✅ 오더당 여러 하불 건 추가
- ✅ 수익 자동 계산 (청구 - 하불)
- ✅ 오더 상세 페이지에서 관리

### 5. 코드 관리
- ✅ 상하차지 코드 (165개)
- ✅ 선사 코드 (63개)
- ✅ 협력업체 (배차업체) (164개)
- ✅ 엑셀 파일에서 자동 임포트
- ✅ 추가/삭제 기능

### 6. 거래처 관리 (Updated! 2026-01-07)
- ✅ **청구처-영업담당자 관리** (144개)
  - 청구처 목록 조회
  - 청구처별 영업담당자 추가/수정/삭제
  - 검색 기능 (청구처명, 영업담당자명)
- ✅ **청구처 상세 정보**
  - 담당자 관리 (이름, 연락처, 메모)
  - 화주 관리 (이름, 메모)
  - 2열 그리드 카드 레이아웃
- ✅ **화주별 견적 관리** (NEW!)
  - 작업지별 견적 등록 (노선, 가격, 컨테이너 사이즈)
  - 견적 사진 업로드 (Base64, 5MB 제한)
  - 견적 조회/수정/삭제
  - 사진 미리보기 및 전체 화면 모달
- ✅ **오더 입력 시 자동 표시**
  - 청구처 선택하면 영업담당자 자동 조회 및 표시
  - 모든 오더 타입(수출/수입/LCL) 지원
- ✅ 청구업체 관리
- ✅ 화주 관리 (청구업체 하위)
- ✅ 작업지 관리 (화주 하위)
- ✅ 계층 구조 (청구업체 > 화주 > 작업지)
- ✅ 하불업체 (협력업체) 관리

### 7. 엑셀 다운로드
- ✅ 전산다운 기능 (CSV 형식)
- ✅ 필터링된 오더만 다운로드
- ✅ 한글 깨짐 방지 (UTF-8 BOM)
- ✅ 지정된 컬럼 포맷 (A~AB열)
- ✅ **추가 청구/하불 다중건 처리**
  - 청구 3건, 하불 2건 → 3개 행으로 분리
  - BKG/BL/NO에 계정명 자동 추가 (예: `계정1_ABC123`)
  - 컨테이너 넘버에도 계정명 추가
  - 개별 청구/하불 금액 및 수익 계산

### 8. 청구/하불 관리 (NEW!)
- ✅ **청구 추가**: 오더별로 여러 청구 건 추가 가능
  - 계정명 필드 (선택): 엑셀 다운로드 시 BKG/BL 앞에 표시
  - 금액 필드 (필수)
- ✅ **하불 추가**: 오더별로 여러 하불 건 추가 가능
  - 계정명 필드 (선택): 엑셀 다운로드 시 BKG/BL 앞에 표시
  - 금액 필드 (필수)
- ✅ 청구/하불 개별 삭제
- ✅ 합계 및 수익 자동 계산
- ✅ **계정명 템플릿 관리 (API 구현 완료)**
  - 자주 사용하는 계정명 미리 등록
  - 사용 횟수 추적
  - 유형별 분류 (청구/하불/공통)

### 9. 엑셀 업로드 고급 기능 (NEW!)
- ✅ **다중건 자동 인식 및 그룹핑**
  - 같은 BKG/BL 번호가 여러 행에 있으면 자동으로 하나의 오더로 통합
  - 각 행의 청구/하불 금액을 개별 항목으로 분리 저장
  - 계정명 자동 추출 (`계정명_BKG123` 형식)
  - 작업일 + BKG/BL + 화주 기준으로 그룹핑

### 10. LCL 오더 상하차지 표시 및 배차 상태 시각화 (NEW! 2026-01-07)
- ✅ **LCL 오더 상하차지 표시**
  - 작업지 대신 상하차지 표시
  - 카드 뷰: "상차지: <값> / 하차지: <값>" 형식
  - 일별 뷰 테이블: 상하차지 열에 굵은 글씨로 강조
  - 미정인 경우 "상차지: 미정" 명시적 표시
- ✅ **배차/차량 미배정 시각화**
  - 배차업체 또는 차량정보가 없으면 빨간 배경 강조
  - 경고 아이콘 (⚠️) 추가
  - 카드 뷰와 테이블 뷰 모두 적용
  - "미지정" 텍스트로 명확한 상태 표시
- ✅ **오더 상태 개선**
  - 배차/차량 정보 누락 오더 즉시 식별 가능
  - LCL 오더 정보 명확성 향상

### 11. 할일 메모
- ✅ 간단한 할일 추가/삭제
- ✅ 완료 체크
- ✅ 메모 관리

## 📊 데이터 모델

### 운송 오더 (transport_orders)
- 컨테이너 수출: BKG, 사이즈, 선사, 모선, 수출국, 접안일/출항일, 상하차지, 중량, 배차, 차량, 컨테이너 넘버, T.W, 씰 넘버
- 컨테이너 수입: BL, 컨테이너 넘버, 사이즈, 선사, 모선, 접안일/출항일, 상하차지, DO, 면장, 배차, 차량
- 벌크화물/LCL: NO, 청구처, 화주, 선사, 상차지, 하차지, 배차, 차량, 차량정보

### 청구/하불 (billings/payments)
- 오더당 여러 건 가능
- 금액, 설명

### 거래처 (계층 구조)
- 청구업체 (billing_companies)
  - 화주 (shippers)
    - 작업지 (work_sites) - 작업지 코드 포함

### 코드 관리
- 상하차지 코드 (location_codes)
- 선사 코드 (shipping_lines)
- 협력업체 (dispatch_companies)

## 🔄 상태 관리

### 컨테이너 수출
- **미배정**: 배차에 아무것도 없음
- **미배차**: 배차에는 있으나, 컨테이너 넘버/씰 넘버/차량 정보 없음
- **완료**: 모든 정보 입력 완료

### 컨테이너 수입 / LCL
- **미배차**: 차량 정보 없음
- **완료**: 차량 정보 입력 완료

### 계근 체크
- 중량에 "계근" 또는 "공만차 계근" 단어가 있으면 자동 체크

## 📝 엑셀 다운로드 형식

CSV 파일로 다운로드되며, 다음 컬럼으로 구성됩니다:

| 컬럼 | 내용 |
|------|------|
| A | 수입OR수출여부 |
| B | (비어있음) |
| C | 작업일 |
| D | 청구처 |
| E | 화주 |
| F | 작업지코드 |
| G | 작업지 |
| H | 컨테이너사이즈 |
| I | 상차지 (LCL은 빈칸) |
| J | 상차지 코드 (LCL은 빈칸) |
| K | 하차지 (LCL은 빈칸) |
| L | 하차지 코드 (LCL은 빈칸) |
| M | 선사 (LCL은 XXXX) |
| N | 선사코드 |
| O | 선명 (수입/LCL은 -) |
| P | 접안일 (수입/LCL은 -) |
| Q | 컨테이너 넘버 (LCL은 차량 정보) ⭐계정명 포함 |
| R | 씰넘버 (수입/LCL은 -) |
| S | 배차업체 |
| T | 차량정보 |
| U | 배차업체 (중복) |
| V | 청구금액 ⭐개별 금액 |
| W | 하불금액 ⭐개별 금액 |
| X | 수익 (청구-하불) ⭐개별 수익 |
| Y | BKG/BL/NO ⭐계정명 포함 |
| Z | 담당자 |
| AA | 영업담당자 |
| AB | 비고 |

### 추가 청구/하불 처리 로직
- **오더 1개 + 청구 3건 + 하불 2건** → **3개 행** 생성
- **행1**: 청구1 금액 / 하불1 금액 / `계정1_ABC123` (BKG/BL)
- **행2**: 청구2 금액 / 하불2 금액 / `계정2_ABC123`
- **행3**: 청구3 금액 / (빈칸) / `계정3_ABC123`
- **컨테이너 넘버**에도 동일하게 계정명 추가

## 🛠️ 개발 가이드

### 로컬 개발 실행
```bash
# 의존성 설치
npm install

# 데이터베이스 마이그레이션
npm run db:migrate:local

# 시드 데이터 삽입
npm run db:seed

# 빌드
npm run build

# PM2로 개발 서버 시작
pm2 start ecosystem.config.cjs

# 로그 확인
pm2 logs --nostream
```

### 데이터베이스 관리
```bash
# 로컬 DB 리셋
npm run db:reset

# 로컬 DB 콘솔
npm run db:console:local

# 마이그레이션 적용
npm run db:migrate:local
```

### 엑셀 데이터 임포트
```bash
# 상하차지/선사 코드 파싱
python parse_excel.py 파일.xlsx codes

# SQL 생성
python generate_seed.py

# DB 삽입
npm run db:seed
```

## 🚧 미구현 기능

### 1. 거래처 관리 추가 기능
- 청구업체-화주-작업지 계층 트리 뷰
- 작업지 코드 자동 완성

### 2. 오더 관리 개선
- 상하차지/선사 자동완성 (코드 자동 입력)
- 오더 수정 모달 개선

### 3. 코드 관리 개선
- 추가 모달 UI
- 일괄 임포트 기능

## 📦 의존성

```json
{
  "dependencies": {
    "hono": "^4.11.0"
  },
  "devDependencies": {
    "@cloudflare/workers-types": "^4.20250705.0",
    "@hono/vite-cloudflare-pages": "^0.4.2",
    "typescript": "^5.0.0",
    "vite": "^6.3.5",
    "wrangler": "^4.4.0"
  }
}
```

## 🗄️ 데이터베이스 통계

- **상하차지 코드**: 165개
- **선사 코드**: 63개
- **협력업체**: 164개
- **청구처-영업담당자 매핑**: 144개
  - 김수형 이사님: 39개
  - 윤재훈 대표님: 32개
  - 박태석 이사님: 19개
  - 이탁건 과장님: 16개
  - 김태훈 전무님: 12개
  - 표정욱 차장님: 12개
  - 기타: 14개

## 📋 다음 단계 개발 우선순위

1. ⭐ **오더 수정 기능** - 기존 오더 수정 모달 개선
2. ⭐ **거래처 관리 UI** - 계층 구조 트리 뷰
3. 코드 추가 모달 - 상하차지/선사/협력업체 추가
4. 작업지 코드 자동완성 - 오더 입력 시 자동 매칭
5. 통계 대시보드 - 월별/업체별 수익 현황

## 🔒 보안 및 인증

현재 버전은 개발 환경이며, 인증 기능이 없습니다.
프로덕션 배포 시 다음 기능 추가 필요:
- 로그인/로그아웃
- 사용자 권한 관리
- API 인증

## 📝 라이센스

이 프로젝트는 내부용으로 개발되었습니다.

## 📞 문의

개발자에게 문의하세요.

---

**최종 업데이트**: 2026-01-07
**버전**: 1.2.0
**상태**: ✅ 운영 중 (LCL 상하차지 표시 및 배차 상태 시각화 추가)
